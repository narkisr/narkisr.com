{:title "PI crypt"
 :layout :post
 :tags  ["raspberry" "pi" "security" "encryption"]
 :toc false}

### Intro
Raspberry PI devices are on the rage now, they are cheap portable and run Linux, using such a device on a remote site (be it for remote backup or pentesting) requires you to keep sensitive data on remote sdcards/USB drives etc.

In this post ill walk though how to setup root encrypted RPi (using Luks on an external USB drive is much simpler and left as an exercise for the reader).

#### The Walk
Iv used a lot of resources (see the [footnotes](#footnotes)) and posts in order to get a working solution using Ubuntu 15.10 as the host and Raspbian [Jessie lite](https://www.raspberrypi.org/downloads/raspbian/) as the Pi OS image.

First we will setup the sdcard:

```bash
# prepare the image
$ wget https://downloads.raspberrypi.org/raspbian_lite_latest
# we assume the sdcard 
$ dd if=2016-03-18-raspbian-jessie-lite.img of=/dev/sdb bs=4M
```

Now we will setup the chroot:
```bash
$ aptitude install qemu-user-static
# chrooting mostly same as in kali
$ mkdir -p /mnt/chroot/boot
$ mount /dev/sdb2 /mnt/chroot/
$ mount /dev/sdb1 /mnt/chroot/boot/
$ mount -t proc none /mnt/chroot/proc
$ mount -t sysfs none /mnt/chroot/sys
$ mount -o bind /dev /mnt/chroot/dev
$ mount -o bind /dev/pts /mnt/chroot/dev/pts
$ cp /usr/bin/qemu-arm-static /mnt/chroot/usr/bin/
# And we are home
$ LANG=C chroot /mnt/chroot/
$ uname -a
 Linux foo 4.2.0-25-generic #30-Ubuntu SMP Mon Jan 18 12:31:50 UTC 2016 armv7l GNU/Linux
```

Now we will move to setup the system (yes your are running arm binaries on your x86 machine):

```bash
# Comment out the single line in this file (or else apt-get wont work)
$ vi /etc/ld.so.preload
$ apt-get update
$ apt-get install busybox cryptsetup dropbear -y
```

Our first mkinitramfs (the small dropbear that will load prior to the OS):

```bash
$ ls -l /lib/modules/ |awk -F" " '{print $9}'
4.1.19+
4.1.19-v7+

# You can ignore the 'Unsupported ioctl: cmd=0x5331' at the end
$ mkinitramfs -o /boot/initramfs.gz 4.1.19-v7+
$ update-rc.d ssh enable
# set the root password for the init image
$ passwd
# Now edit and change/add root=/dev/mapper/crypt_sdcard cryptdevice=/dev/mmcblk0p2:crypt_sdcard 
$ vi /boot/cmdline.txt
# add 'initramfs initramfs.gz 0x00f00000'
$ vi /boot/config.txt
```

Now copy the private ssh key that will enabled you to ssh to the dropbear instance (the one that will enabled you to enter the decryption password):

```bash
# copy the key back to the host for later use
$ cat /etc/initramfs-tools/root/.ssh/id_rsa
```

At this point we are ready to change the mounting to our future to be crypt_sdcard:

```bash
$ cat /etc/fstab
proc /proc proc defaults 0 0
/dev/mmcblk0p1 /boot vfat defaults 0 2
/dev/mapper/crypt_sdcard / ext4 defaults,noatime 0 1

# A lot of errors will fly out since we don't have encryption set yet, its safe the ignore them for now
$ mkinitramfs -o /boot/initramfs.gz 4.1.19-v7+
``` 

Now we will un-chroot and copy our work aside so we can copy it back once the drive is encrypted:

```base
$ exit
$ umount /mnt/chroot/boot
$ umount /mnt/chroot/sys
$ umount /mnt/chroot/proc
# Backup our work thus far
$ mkdir -p /mnt/backup
$ rsync -avh /mnt/chroot/* /mnt/backup/
# finalize the un-chrooting
$ umount /mnt/chroot/dev/pts
$ umount /mnt/chroot/dev
$ umount /mnt/chroot
```

Now we will move to setting the encrypted drive

#### Footnotes:

* <small> The original tutorial for [Kali](https://www.offensive-security.com/kali-linux/raspberry-pi-luks-disk-encryption/]) Linux which gives a good outline (doesn't work as is on Raspbian tough).</small>
* <small> A [post](https://hblok.net/blog/posts/2014/02/06/chroot-to-arm/) which mainly helped me to solve 'qemu: uncaught target signal 4' error. </small>
* <small> A [post](https://www.raspberrypi.org/forums/viewtopic.php?f=66&t=130268) that helped solved the 'debian /sbin/cryptsetup: not found raspbian'  errors </small>

