<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Narkisr.com: Waiting for your future</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" >
    <!-- <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css"> -->
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.1/styles/default.min.css">
        <link href="/css/screen.css" rel="stylesheet" type="text/css" />
	  <link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
	  <link href="/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    </head>
    <body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">

            <div class="navbar-header">

                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
			  <span class="icon-bar"></span>
			</button>

		    </div>
		    <ul class="nav navbar-nav navbar-right">
			<li><a class="btn" href=/atom.xml ><i class="fa fa-rss"></i></a></li>
			<li><a class="btn" href="http://twitter.com/narkisr" ><i class="fa fa-twitter"></i></a></li>
			<li><a class="btn" href="https://github.com/narkisr" ><i class="fa fa-github-alt"></i></a></li>
			<li><a class="btn" href="http://il.linkedin.com/in/narkisr/" ><i class="fa fa-linkedin"></i></a></li>
                  <li><a class="btn" href="/pages/about" >
                    <img style='border-radius: 50%;'  src="/img/me-small.jpg" height="60%" width="60%"/></a>
                  </li>
		    </ul>
		    <!-- nav links -->
		    <div id="navbar" class="navbar-collapse collapse">
			<ul class="nav navbar-nav">
			  <li ><a href="/">Home</a></li>
			  <li ><a href="/archives/">Archives</a></li>
			  
			  <li >
			  <a href="/pages/projects/">Projects</a>
			  </li>
			  
			  <li >
			  <a href="/pages/presentations/">Presentations</a>
			  </li>
			  
			</ul>
		    </div><!--/.nav-collapse -->
		  </div>
		</nav>

		<div id="wrapper" class="container">
		  <div class="row">
		    <div class="col-md-8">
			<div id="content">
			  
<div id="post">
    <div id="post-header">
    <h2>Waiting for your future</h2>
    <div id="post-meta">
        
        <div class="date">24 July 2012</div>
    </div>
</div>
<div>
    
    <p> So, you've got an action that you want to run in parallel using multiple cores, in pure Java land you have the old fashioned Thread.start which takes a Runnable implementation, another option is the  <a href='http://docs.oracle.com/javase/6/docs/api/java/util/concurrent/ExecutorService.html'>ExecutorService</a>  which uses a pool to store a collection of reusable threads (in fact its the same pool that agents use).  Clojure on the other hand has the  <a href='http://clojuredocs.org/clojure_core/clojure.core/future'>future</a>  macro which takes a body of code and runs it on a seprate thread:</p><pre><code class="clojure">&#40;def f &#40;future &#40;println &quot;hello&quot;&#41;&#41;&#41;
  
@f ; will block here until it executes 
</code></pre><p>Futures use an unbound thread pool which is good for IO bound actions, lets assume we have a sequence (a large one at that) that serves as an input to that heavy IO operation, we want to parallelize the operation on multiple cores, the naive approach will be:</p><pre><code class="clojure"> &#40;defn action &#91;i&#93;
    &#40;Thread/sleep 4000&#41;
    &#40;println i&#41;&#41;

&#40;defn -main &#91;&#93;
  &#40;map &#40;future &#40;action %&#41;&#41; &#40;range 1000&#41;&#41;&#41;
</code></pre><p>Running this code will result with no future run, the main thread will exit before any future gets the chance to execute (since its async), in order to wait for them to run we need to deref all futures,<br /></p><pre><code class="clojure"> &#40;defn -main &#91;&#93;
  &#40;map deref &#40;map &#40;future &#40;action %&#41;&#41; &#40;range 1000&#41;&#41;&#41;&#41; 
</code></pre><p>This looks good and indeed when we run it we notice the following output</p><pre><code class="clojure">0
1 
.. ; omitted for brevity 
.. 
31
nil nil nil  ; after a delay 
32
..
..
63 ; order is random 
</code></pre><p>So whats going on here? we a get a lot less concurrency then we'd like, what we see here is Clojure chunking in action, since the inner map is lazy we produce 32 futures in each chunk deref them and carry on to the next, we could force all futures by using doall:</p><pre><code class="clojure">&#40;defn -main &#91;&#93;
  &#40;map deref &#40;doall &#40;map &#40;future &#40;action %&#41;&#41; &#40;range 1000&#41;&#41;&#41;&#41;&#41;
</code></pre><p>This poses another problem, we issue 1000 future and hammer on, this might cause the IO target to grind into a halt (be it filesystem or remote web service), a more controled method is required.  One option is to use Java's own ExecutorService and submit actions into that (using a bounded pool) and in fact thats exactly what <a href='https://github.com/pallet/pallet-thread'>pallet thread</a>  enables us to do.</p><p>Now we want to implement two main requirements, the first generate a blocked amount of running actions, the second make sure not to block the execution of actions (by chunking for example) if threads are available to handle them:<br /></p><pre><code class="clojure">&#40;use '&#91;pallet.thread.executor :only &#40;executor execute&#41;&#93;&#41;  
 
&#40;def pool
  &#40;executor {:prefix &quot;foo&quot; :thread-group-name &quot;foo-grp&quot; :pool-size 4}&#41;&#41;

&#40;defn bound-future &#91;f&#93;
 {:pre &#91;&#40;ifn? f&#41;&#93;}; saves lots of errors
  &#40;execute pool f&#41;&#41;

&#40;defn wait-on &#91;futures&#93;
  &quot;Waiting on a sequence of futures, limited by a constant pool of threads&quot;
  &#40;while &#40;some identity &#40;map &#40;comp not future-done?&#41; futures&#41;&#41;
    &#40;Thread/sleep 1000&#41; 
    &#41;&#41; 

&#40;defn -main &#91;&#93;
  &#40;wait-on &#40;map #&#40;bound-future &#40;fn &#91;&#93;  &#40;action %&#41;&#41;&#41; &#40;range 1000&#41;&#41;&#41;&#41;
</code></pre><p>The print will now look like </p><pre><code class="clojure">0
1
2
3
; a short delay for the next 4 actions to kick into action
1
..
</code></pre><p>I found this method to offer a balance between the spread of work and predictable load on the target.</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/Clojure/">Clojure</a>
    
    <a href="/concurrency/">concurrency</a>
    
    <a href="/future/">future</a>
    
</div>

    <div id="prev-next">
        
        <a href="/posts/13-04-2013-tf101-cyanogenmod/">&laquo; Asus TF101 Cyanogenmod</a>
        
        
        ||
        
        
        <a href="/posts/20-07-2012-raspberri-pi/">Raspberry foo &raquo;</a>
        
    </div>

    
    <div id="disqus_thread"></div>
<script>
var disqus_config = function () {
this.page.url = "http://narkisr.com/posts/24-07-2012-waiting-for/";
this.page.identifier = "Waiting for your future";
};
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//narkisrcom.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

    


</div>

			</div>
		    </div>

		    <div class="col-md-3">
			<div id="sidebar">
			  <ul id="links">

			    
			    <li><a href="/pages/about/">About</a></li>
			    
			  </ul>
			  <div id="recent">
			    <h3>Recent Posts</h3>
			    <ul>
				
				<li><a href="/posts/04-02-2018-types-mismatch/">When types are eating away your sanity (types impedance mismatch)</a></li>
				
				<li><a href="/posts/17-01-2018-dependencies/">The balancing game</a></li>
				
				<li><a href="/posts/16-04-2016-pi-crypt/">PI crypt</a></li>
				
			    </ul>
			  </div>
			  <div id="tags">
			    <h3>Tags</h3>
			    <ul>
				
				<li><a href="/js/">js</a></li>
				
				<li><a href="/security/">security</a></li>
				
				<li><a href="/dependencies/">dependencies</a></li>
				
				<li><a href="/raspberry/">raspberry</a></li>
				
				<li><a href="/encryption/">encryption</a></li>
				
				<li><a href="/cyanogenmod/">cyanogenmod</a></li>
				
				<li><a href="/wifi/">wifi</a></li>
				
				<li><a href="/design/">design</a></li>
				
				<li><a href="/asus/">asus</a></li>
				
				<li><a href="/opskeleton/">opskeleton</a></li>
				
				<li><a href="/tf101/">tf101</a></li>
				
				<li><a href="/management/">management</a></li>
				
				<li><a href="/software/">software</a></li>
				
				<li><a href="/linux/">linux</a></li>
				
				<li><a href="/types/">types</a></li>
				
				<li><a href="/pi/">pi</a></li>
				
				<li><a href="/Clojure/">Clojure</a></li>
				
				<li><a href="/vagrant/">vagrant</a></li>
				
				<li><a href="/concurrency/">concurrency</a></li>
				
				<li><a href="/future/">future</a></li>
				
				<li><a href="/impedance/">impedance</a></li>
				
				<li><a href="/android/">android</a></li>
				
				<li><a href="/raspberry-pi/">raspberry-pi</a></li>
				
				<li><a href="/nodejs/">nodejs</a></li>
				
			    </ul>
			  </div>
			</div>
		    </div>
		  </div>
		  <footer class="footer"><div class="span-24 small quite last">
			<span href="http://purl.org/dc/dcmitype/Text" property="dc:title" rel="dc:type" xmlns:dc="http://purl.org/dc/elements/1.1/"> This website content</span> by <a href="narkisr.com" property="cc:attributionName" rel="cc:attributionURL" xmlns:cc="http://creativecommons.org/ns#"> Ronen Narkis </a> is licensed under a <a href="http://creativecommons.org/licenses/by/2.5/il/" rel="license">Creative Commons Attribution 2.5 Israel License</a>, based on a work at <a href="narkisr.com" rel="dc:source" xmlns:dc="http://purl.org/dc/elements/1.1/">narkisr.com</a>, Permissions beyond the scope of this license may be available at <a href="narkisr.com" rel="cc:morePermissions" xmlns:cc="http://creativecommons.org/ns#">narkisr.com</a>.</div>
		  </footer>
		</div>
		<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
		<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
		<script src="/js/highlight.pack.js" type="text/javascript"></script>
		<script>hljs.initHighlightingOnLoad();</script>
	    </body>
	  </html>

